{% extends 'apka/base.html' %}

{% block upper_menu%}
<!-- <a class="button" href="upload_file" style="text-decoration: none">Add File</a> -->
<button class="button" onclick="openUploadFileForm()" style="text-decoration: none">Add File</button>
<button class="button" onclick="openUploadFolderForm()" style="text-decoration: none">Add Folder</button>
<button class="button" onclick="openDeleteFileForm()" style="text-decoration: none">Delete File</button>
<button class="button" onclick="openDeleteFolderForm()" style="text-decoration: none">Delete Directory</button>
<form class="button" method=POST>
    {% csrf_token %}
    <input type='submit' name="run" value="Run">
</form>
{% endblock upper_menu %}

{% block file_selection %}
    {% include "apka/show_folders.html" with tree=tree free_files=free_files %}
{% endblock file_selection %}

{% block tabs %}

<form method="POST">
    {%csrf_token %}
    <button name="tab" value="1">Provers</button>
    <button name="tab" value="2">VCs</button>
    <button name="tab" value="3">Result</button>
</form>

{% endblock tabs %}

{% block code %}
    {% if file != None %}
        <h3>{{file.name}}</h3>
            {%if file.description%}
                <p>Description: {{file.description}}</p>
            {% endif %}    
            <!-- <p>Created: {{file.creation_date}}</p> -->
            <pre>{{file.display_text}}</pre>
        {% endif %}
{% endblock code %}


{% block tab_data %}
    {% if tab == '1' %}
        <form action = "" method = "post">
            {% csrf_token %}
            {{ prover_form }}
            <input type="submit" name="submit_prover" value="Submit">
        </form>
    {% elif tab == '2' %}
        <form action = "" method = "post">
            {% csrf_token %}
            {{ vc_form }}
            <input type="submit" name="submit_vc" value="Submit">
        </form>
    {% elif tab == '3' %}
        {% if file != None %}
             <pre> {{ file.frama_result }} </pre>
        {% endif %}
    {% endif %}
{% endblock tab_data %}

{% block program_elements %}
    {% for section in file.filesection_set.all %}
        {% if section.status_data_fk.validity_flag and section.status_data_fk.status_data != "" %}
            <div class={{section.status_fk.status}}>
                <p>Prover: {{section.status_data_fk.prover }}</p>
                <div class="status">{{section.status_data_fk.status_data|linebreaks}}
                    <span class="statustext">
                        line: {{section.line}}{{section.desc|linebreaks}}
                    </span>
                </div>
            </div>
        {%endif%}    
{% endfor %}
{% endblock program_elements %}

{% block popups %}

{% include "apka/upload_file.html" %}

{% include "apka/upload_directory.html" %}

{% include "apka/delete_directory.html" with directories=directories %}

{% include "apka/delete_file.html" with files=files %}

<script type="text/javascript">
    function openUploadFileForm() {
        document.getElementById("uploadFileDiv").style.display = "block";
    }
    function closeUploadFileForm() {
        document.getElementById("uploadFileDiv").style.display = "none";
    }
    function openUploadFolderForm() {
        document.getElementById("uploadFolderDiv").style.display = "block";
    }
    function closeUploadFolderForm() {
        document.getElementById("uploadFolderDiv").style.display = "none";
    }
    function openDeleteFolderForm() {
        document.getElementById("deleteFolderDiv").style.display = "block";
    }
    function closeDeleteFolderForm() {
        document.getElementById("deleteFolderDiv").style.display = "none";
    }
    function openDeleteFileForm() {
        document.getElementById("deleteFileDiv").style.display = "block";
    }
    function closeDeleteFileForm() {
        document.getElementById("deleteFileDiv").style.display = "none";
    }
    $('#deleteFileForm').submit(function(event) {
        event.preventDefault();
        $.post(
            $(this).attr('action'),
            $(this).serialize(),
            function (response) {
                $(".side-nav").html(response);
            });
    })

    $("#deleteFolderForm").submit(function(event){
        event.preventDefault();
        $.post(
            $(this).attr('action'),
            $(this).serialize(),
            function (response) {
                $(".side-nav").html(response);
            });
    })

    $("#uploadFolderForm").submit(function(event){
        event.preventDefault();
        $.post(
            $(this).attr('action'), 
            $(this).serialize(),
            function (response) {
                // log the result
                $(".side-nav").html(response);
            })
    })

    $('#uploadFileForm').submit(function(e) {
        e.preventDefault();
        $form = $(this)
        var formData = new FormData(this);
        $.ajax({
            url: $('#uploadFileForm').attr('action'),
            type: 'POST',
            data: formData,
            success: function (response) {
                $(".side-nav").html(response);
            },
            cache: false,
            contentType: false,
            processData: false,
            headers: {
                "X-CSRFToken": '{{ csrf_token }}'
            },
            enctype: 'multipart/form-data'
        })
    });
    // function runUploadFileForm() {
    //     var myForm = document.getElementById('uploadFileForm');
    //     var formData = new FormData(myForm);
    //     $.post(
    //         $('#uploadFileForm').attr('action'), 
    //         $('#uploadFileForm').serialize(),
    //         function (data) {
    //             // log the result
    //             // $(".side-nav").html(data);
    //             alert("ALERT");
    //         })
    // }

// $("#run_upload_file").click(runUploadFileForm());
    
</script>

{% endblock popups %}